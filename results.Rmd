---
title: "The association of demographic factors with negative desriptors in medical text"
author: "Andrew Zimolzak, Traber Giardina, Darius Dawson, Terri Fletcher, Taylor Scott, Debra Choi"
date: 'April, 2022'
output: pdf_document
---

```{r libraries, echo=FALSE, message=FALSE, warning=FALSE}
library(ggplot2)
library(here)
library(knitr)
library(dplyr)
library(ROCR)

source(file=here("functions.R"))
```

```{r read CSV, echo=FALSE}
joined <- read.csv(
  here('analytic_dataset_tm.csv'), sep=",",
  stringsAsFactors = FALSE
) 
```

```{r write-cleaner-csv, echo=FALSE}
joined %>%
  select(-ends_with("_sum"), -n, -demog_entries) -> out

out %>%
  write.csv(here('analytic dataset v0xx 2022-04-xx.csv'))
```

# Introduction

Recent work (PMID 35044842) used an
expert panel to develop a list of negative patient descriptors and found
that Black patients had disproportionately higher odds of negative
patient descriptors appearing in the history and physical notes of their
medical records compared with White patients.

We measured the association of race, ethnicity, and sex with these negative descriptors, in BCM patients with an ER visit and inpatient stay.

# Tables and figures

```{r fig-area, echo=FALSE, message=FALSE, warning=FALSE}
joined %>%
  select(race_ethn, negativity_any) %>%
  group_by(race_ethn, negativity_any) %>%
  summarise(tot = n()) %>%
  arrange(negativity_any, race_ethn) -> race_neg_count

joined %>%
  group_by(negativity_any) %>%
  summarise(grand_tot = n()) -> neg_count

left_join(neg_count, race_neg_count, by="negativity_any") %>%
  mutate(proportion = tot / grand_tot) -> stack_plot_me

ggplot(stack_plot_me, aes(x=negativity_any, y=proportion)) + geom_col(aes(fill = race_ethn)) -> final_plot

final_plot
```
**Figure. Distribution of race/ethnicity, in notes without negative descriptors, compared to notes with negative descriptors.** Latino patients are overrepresented among notes that contain one or more negative descriptor words. Here, the Latino grouping comprises *any* race, whereas the other groupings comprise *non-Latino* patients of the specified race.




```{r table-race-ethn, echo=FALSE}
table(joined$race_ethn, joined$negativity_any) -> final_race
fisher.test(final_race)[["p.value"]] -> final_race_p
final_race %>% kable()
```
**Table 1. Distribution of race/ethnicity, in notes without negative descriptors, compared to notes with negative descriptors.** The column "TRUE" means notes with one of the negative descriptors. *P* = `r final_race_p`, Fisher's exact test.




```{r table-sex, echo=FALSE}
table(joined$Sex, joined$negativity_any) -> x
round((x[1,] / (x[1,] + x[2,])), 3) -> proportion.f  # adhoc
fisher.test(x)[["p.value"]] -> sex_p
rbind(x, proportion.f) %>% kable()
```
**Table 2. Distribution of sex, in notes with/without negative descriptors.** There are proportionally fewer women / more men represented among notes containing negative descriptors. *P* = `r sex_p`




```{r table-ethn, echo=FALSE}
table(joined$Ethnic.Group, joined$negativity_any) -> x
round((x[1,] / (x[1,] + x[2,])), 3) -> proportion.lat  # adhoc
fisher.test(x)[["p.value"]] -> ethn_p
rbind(x, proportion.lat) %>% kable()
```
**Table 3. Distribution of ethnicity, in notes with/without negative descriptors.** There are proportionally more Latino patients represented among notes containing negative descriptors. *P* = `r ethn_p`





```{r table-race, echo=FALSE}
table(joined$Race, joined$negativity_any) -> x
colSums(x) -> total
round((x['Black or African American',] / total), 3) -> proportion.black
fisher.test(x)[['p.value']] -> race_alone_p
rbind(x, total, proportion.black) %>% kable()
```
**Table 4. Distribution of race, in notes with/without negative descriptors.** There are more black / African-American patients represented among notes containing negative descriptors. Here, Latino patients can be in any grouping, although the majority are white Latino. *P* = `r ethn_p` *P* = `r race_alone_p`




# Discussion

There are fewer women (`r proportion.f[2]*100` vs. `r proportion.f[1]*100` percent) represented among notes containing any negative descriptor, compared to notes without a negative descriptor (*P* = `r sex_p`).

There are more Latino patients (`r proportion.lat[2]*100` vs. `r proportion.lat[1]*100` percent) than non-Latinos represented among notes containing any negative descriptor (*P* = `r ethn_p`).

There are more black patients (`r proportion.black[2]*100` vs. `r proportion.black[1]*100` percent) represented among notes with any negative descriptor (*P* = `r race_alone_p`).

Considering the *combination* of race and ethnicity fields, (that is, with the major groups being black, Latino, and white non-Latino,) there is a significant difference in distribution of groups between notes with vs. without a negative descriptor (*P* = `r final_race_p`).




# Data lessons learned

- Data retrieval and cleaning takes time!
- Handing off a dataset is not trivial (receiving end does not know how it was made, or column meanings, and may need explanations for unexpected associations).
- Project management: often linear not parallel, critical path, tricky to involve whole team.
- It is possible to do things fast.
- Record keeping is important, even when going fast.




# Misc. results (too detailed)

The analysis is pretty sensitive to the phrasing of the descriptors. Limiting to "unpleasant" results in far fewer notes than "pleasant." Also, making that change results in more negativity for: *men, non-Latinos, and black patients,* unlike the prior word list when it was just the substring "pleasant."

In these tables, an upward trend in ratio means positive correlation of underprivileged group status and negative descriptors. In other words, ratios are $r = u / p$, where $u$ is the count from a group hypothesized to be underprivileged, and $p$ is the group hypothesized to be privileged.

## Sex vs. negative descriptors

```{r table s}
table(joined$Sex, joined$negativity) -> x
round((x[1,] / x[2,]), 3) -> f.m.ratio  # adhoc
rbind(x, f.m.ratio) %>% kable()
```

```{r trend test s}
women <- x[1,]  # adhoc
totals <- x[1,] + x[2,]  # adhoc
prop.trend.test(women, totals)
```

## Ethnicity vs. negative descriptors

```{r table e}
table(joined$Ethnic.Group, joined$negativity)  -> x
round((x[1,] / x[2,]), 3) -> latino.non.ratio  # adhoc
rbind(x, latino.non.ratio) %>% kable()
```

```{r trend test e}
latino <- x[1,]  # adhoc
totals <- x[1,] + x[2,]  # adhoc
prop.trend.test(latino, totals)
```

## Race vs. negative descriptors

```{r table race}
table(joined$Race, joined$negativity)  -> x
round((x['Black or African American',] / x['White or Caucasian',]), 2) -> b.w.ratio
rbind(x, b.w.ratio) %>% kable()
```

```{r trend test race}
black <- x['Black or African American',]
totals <- colSums(x)
prop.trend.test(black, totals)
```

## Single proportion line plot

```{r plot-multi-line, echo=FALSE, message=FALSE, warning=FALSE}
xvals = as.numeric(colnames(x))
N = length(xvals)

line_plot_me = data.frame(
  Proportion = c(women / totals, black / totals, latino / totals),
  Group = c(rep('Women', N), rep('Black', N), rep('Latino', N)),
  negativity = rep(xvals, 3)
)


ggplot(line_plot_me, aes(x=negativity, y=Proportion, color=Group)) +
  labs(x='Negative descriptors in note') +
  geom_line() +
  ylim(0,1)


```




# Combined race/ethnicity vs. negative descriptors

## Without a "cap" on negativity

```{r table combo, echo=FALSE}
table(joined$race_ethn, joined$negativity) -> x

Total <- colSums(x)
p_asian <- round(x['Asian',] / Total, 3)
p_black <- round(x['Black or African American',] / Total, 3)
p_latino <- round(x['Latino',] / Total, 3)
p_white <- round(x['White or Caucasian',] / Total, 3)

rbind(x, Total, p_asian, p_black, p_latino, p_white) -> unified_table

unified_table %>% kable()
```

```{r trend-test-re-nocap-w}
prop.trend.test(x['White or Caucasian',], Total)
```

```{r trend-test-re-nocap-L}
prop.trend.test(x['Latino',], Total)
```

```{r trend-test-re-nocap-b}
prop.trend.test(x['Black or African American',], Total)
```

## With a "cap" on negativity

```{r table combo binned, echo=FALSE}
table(joined$race_ethn, joined$negativity_binned) -> x

Total <- colSums(x)
p_asian <- round(x['Asian',] / Total, 3)
p_black <- round(x['Black or African American',] / Total, 3)
p_latino <- round(x['Latino',] / Total, 3)
p_white <- round(x['White or Caucasian',] / Total, 3)

rbind(x, Total, p_asian, p_black, p_latino, p_white) -> unified_table_binned

unified_table_binned %>% kable()
```

```{r areaplot, echo=FALSE, message=FALSE, warning=FALSE}
joined %>%
  select(race_ethn, negativity_binned) %>%
  group_by(race_ethn, negativity_binned) %>%
  summarise(tot = n()) %>%
  arrange(negativity_binned, race_ethn) -> race_neg_count

joined %>%
  group_by(negativity_binned) %>%
  summarise(grand_tot = n()) -> neg_count

left_join(neg_count, race_neg_count, by="negativity_binned") %>%
  mutate(proportion = tot / grand_tot) -> stack_plot_me

stack_plot_me %>%
  filter(race_ethn == 'Black or African American' & negativity_binned == 0) -> out
refaa <- out$proportion

stack_plot_me %>%
  filter(race_ethn == 'Latino' & negativity_binned == 0) -> out
refla <- out$proportion

stack_plot_me %>%
  filter(race_ethn == 'White or Caucasian' & negativity_binned == 0) -> out
refwh <- out$proportion

ggplot(stack_plot_me, aes(x = negativity_binned, y = proportion)) +
  geom_area(aes(fill = race_ethn)) +
  geom_hline(yintercept = refwh + refla) +
  geom_hline(yintercept = refwh)
```


```{r trend-test-re-w}
prop.trend.test(x['White or Caucasian',], Total)
```

```{r trend-test-re-L}
prop.trend.test(x['Latino',], Total)
```

```{r trend-test-re-b}
prop.trend.test(x['Black or African American',], Total)
```




# Logistic

## Big model

```{r echo=FALSE}
joined %>%
  select(
    -X, -pat_id, -NOTE_ID,
    -ends_with("_sum"), -n, -demog_entries,
    -negativity, -negativity_binned
  ) -> factor_me
  
factor_me %>%
  summarise(
    across(
      c(
        Sex, race_ethn, Employment.Status, interpreter, Language,
        Marital.Status, mcaid, mcare, Financial.Class
      ), factor
    ),
    Age = Age, negativity_any = negativity_any
  ) -> logit_me
```

```{r logistic}

my_model <- glm(negativity_any ~ ., data = logit_me, family = "binomial")
summary(my_model)

```

## ROC curve

```{r rocr}
rocr_pred = prediction(my_model$fitted.values, my_model$y)
rocr_perf <- performance(rocr_pred, measure = "tpr", x.measure = "fpr")
auc = performance(rocr_pred, measure = "auc")
auc@y.values
```

```{r plot-roc}
plot(rocr_perf, col=rainbow(10), print.cutoffs.at=c(0.01, 0.1))
```

## Little model

```{r little model}
little_model <- glm(negativity_any ~ Sex + race_ethn + Age, data = logit_me, family = "binomial")
summary(little_model)
```

## ROC curve

```{r}
rocr_pred = prediction(little_model$fitted.values, little_model$y)
rocr_perf <- performance(rocr_pred, measure = "tpr", x.measure = "fpr")
auc = performance(rocr_pred, measure = "auc")
auc@y.values
```

```{r}
plot(rocr_perf, col=rainbow(10), print.cutoffs.at=c(0.01, 0.1))
```

## Predicted probabilities, big vs. little

```{r message=FALSE, warning=FALSE}
qplot(my_model$fitted.values) + labs(title = 'Big model')
```

```{r message=FALSE, warning=FALSE}
qplot(little_model$fitted.values) + labs(title = 'Little model') + xlim(0, 0.15)
```

I get the feeling it hates unbalanced classes.

## Try column plot of coefficients

```{r}
df = data.frame(
  y=my_model$coefficients,
  x=names(my_model$coefficients)
)

ggplot(df, aes(x=y, y=x) ) + geom_col() + scale_x_log10() +
  geom_vline(xintercept = 1)

```




# To do, or not

-  Limit only to those discharged from ED to home.
-  More rigorous handling of those with multiple demographic entries.
-  Get complete note data from IT.
-  Show length distribution of notes.
