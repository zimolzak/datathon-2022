---
title: "BCM Datathon Team 17 Data Cleaning"
author: "Andrew Zimolzak, MD, MMSc"
date: 'April, 2022'
output:
  pdf_document: default
  html_document: default
---

```{r libraries, echo=FALSE, message=FALSE, warning=FALSE}
library(ggplot2)
library(here)
library(dplyr)
library(lubridate)
library(data.table)
library(knitr)
library(tableone)
# library(readxl)

source(file=here("functions.R"))
```

```{r import, echo=FALSE}

demog = filename2df('Patient Demographics 17 20220326.txt')  # 0.6 MB
# comor = filename2df('Patient Comorbidities 17 20220327.txt')  # 2.7 MB
edadm = filename2df('Patient ED Admissions 17 20220326.txt')  # 2.9 MB
# edpro = filename2df('Patient ED DX Problem List 17 20220327.txt')  # 19 MB
# medad = filename2df('Patient Meds Admin Times 17 20220327.txt')  # 93 MB
# order = filename2df('Patient Orders 17 20220327.txt')  # 86 MB
notes = read.csv(here('onedrive', 'Working', 'DATA', 'Progress Notes File.csv'),
                 sep=",", stringsAsFactors = FALSE)
```

```{r tidy encounters, echo=FALSE}
edadm %>%
  mutate(
    ed_adm = ymd_hms(EMERGENCY_ADMISSION_DTTM),
	  ed_dis = ymd_hms(ED_DEPARTURE_DTTM),
	  inp_adm = ymd_hms(HOSP_ADMSN_TIME),
	  inp_dis = ymd_hms(HOSP_DISCH_TIME),
  ) %>%
  rename(cc10 = First.Chief.Compliant.ICD10, cc9 = First.Chief.Compliant.ICD9) %>%
  select(
	  PAT_ID, ED.Disposition, Patient.Class, cc10, cc9,
	  ed_adm, ed_dis, inp_adm, inp_dis
  ) %>%
  mutate(
	  adm_adm = (inp_adm - ed_adm) / ddays(),
	  dis_dis = (inp_dis - ed_dis) / ddays(),
	  ed_dur = (ed_dis - ed_adm) / ddays(),
	  inp_dur = (inp_dis - inp_adm) / ddays(),
	  er_vs_inp = inp_dur - ed_dur
  ) -> ed_encounter_tidy
```

# Patient visits

## Patient Class

```{r}
table(ed_encounter_tidy$Patient.Class) %>% kable()
```

## ED Disposition

```{r}
table(ed_encounter_tidy$ED.Disposition) %>% kable()
```

## Don't read this section (diagnostics)

```{r include=FALSE}
table(ed_encounter_tidy$ED.Disposition, ed_encounter_tidy$Patient.Class) %>% kable()

```

My observations:

-   disposition=Discharge and class=Emergency: common but not perfectly?
-   d=Admit c=Inpatient: common
-   d=Observation c=Observation: somewhat common
-   d=Observation c=Inpatient: even more common (surprisingly)
-   d=Admit class=Observation: common
-   c=Outpatient: uncommon in general
-   disposition=Admit class=Emergency: rare

The main dispositions that seem to matter:

-   Discharge
-   Admit
-   Observation
-   Transfer

We could make a more limited table of 4 dispo X 3 class. This is all possibly because we requested ER discharge to home and not admit?

```{r inspect me, include=FALSE}
ed_encounter_tidy %>%
  select(-PAT_ID, -cc10, -cc9) -> sample_me

sample_me %>%
  slice_sample(n=20) %>%
  arrange(Patient.Class, ED.Disposition) %>%
  transmute(
    class = tolower(substr(Patient.Class, 1, 3)),
    dispo = tolower(substr(ED.Disposition, 1, 3)),
    # er1 = ed_adm,
    # er2 = ed_dis,
    # in1 = inp_adm,
    # in2 = inp_dis,
    er1_to_inp1 = round(adm_adm, 2),
    er2_to_inp2 = round(dis_dis, 2),
    los_er = round(ed_dur, 2),
    los_inp = round(inp_dur, 2),
    diff_los = round(er_vs_inp, 2)
  ) %>%
  kable()
```

All numeric values are in **hours.**

Looks like if dispo = discharge, then ER departure time = Hospital discharge time.

## Distribution of encouters per patient ID

```{r, message=FALSE}
ed_encounter_tidy %>%
  count(PAT_ID) -> pat_id_counts

qplot(x=n, data=pat_id_counts) +
  scale_x_log10()
```

## Don't read this section

About those with only 1 encounter

```{r echo=FALSE}
left_join(ed_encounter_tidy, pat_id_counts, by='PAT_ID') %>%
  filter(Patient.Class != 'Outpatient') %>%
  filter(
    ED.Disposition == 'Admit' |
      ED.Disposition == 'Discharge' |
      ED.Disposition == 'Observation' |
      ED.Disposition == 'Transfer to Another Facility'
  ) %>%
  mutate(
    multiple = case_when(
      n > 1 ~ 'mult',
      TRUE ~ 'single'
    )
  ) -> ed_enc_w_counts
```

```{r include=FALSE}
table(ed_enc_w_counts$multiple, ed_enc_w_counts$Patient.Class) %>% kable()
```

```{r include=FALSE}
table(ed_enc_w_counts$multiple, ed_enc_w_counts$ED.Disposition) %>% kable()
```

```{r include=FALSE}
ed_enc_w_counts %>% filter(multiple == 'mult') -> m
ed_enc_w_counts %>% filter(multiple == 'single') -> s
```

```{r crosstab single, include=FALSE}
table(s$Patient.Class, s$ED.Disposition) %>% kable()
```

```{r crosstab mult, include=FALSE}
table(m$Patient.Class, m$ED.Disposition) %>% kable()
```

```{r inspect mult, include=FALSE}
m %>% 
  select(PAT_ID, Patient.Class, ED.Disposition,
         ed_adm, ed_dis, inp_adm, inp_dis, n) %>%
  filter(n < 5) %>%
  arrange(PAT_ID, ed_adm) %>%
  head(25) %>%
  kable() -> inspect_multiples

# inspect_multiples
```

Inspect singles

```{r inspect single, include=FALSE}
s %>% 
  select(PAT_ID, Patient.Class, ED.Disposition,
         ed_adm, ed_dis, inp_adm, inp_dis, er_vs_inp, n) %>%
  arrange(PAT_ID, ed_adm) %>%
  head(25) %>%
  kable() -> inspect_singles

# inspect_singles
```

2022-04-13 meeting notes.

ED admiss and ED discharge is literally when they came/went from ED. Whereas, inpatient admit/dis date and time are about when they *first showed up to hospital* no matter what part of hospital. Many of the obs people will expect to have inp discharge time which is *after* the ED disch time. But not *all.* Occasional data error or whatever.

Also some things come thru diff in Slicer vs Caboodle.

I had noted that: A few (singletons) have an obs admit with an inpatient LOS \> ER los (but not all).

Very likely valid approach: ignore the \~500 patients who are singletons (only one row in the ED Admissions table). Because so few have actual inpatient-looking encounters anyway.

`Pat Enc CSN` will be needed eventually to join up *notes* to *encounters.*

# Demographics

```{r tidy demographics, echo=FALSE}
demog %>%
  mutate(
    mcaid = ! is.na(MEDICAID_NUM),
    mcare = (MEDICARE_NUM != "")
  ) %>%
  select(
    pat_id, Sex, Age, Ethnic.Group, Race, Employment.Status,INTRPTR_NEEDED_YN,
    Language, Marital.Status, mcaid, mcare, Financial.Class
  ) %>%
  rename(
    interpreter = INTRPTR_NEEDED_YN,
  ) -> demographics_tidy

# demographics_tidy %>% head() %>% kable()
```

```{r echo=FALSE}
# addmargins(table(demographics_tidy$Sex)) %>% kable()
# table(demographics_tidy$Race) %>% kable()
# table(demographics_tidy$Ethnic.Group) %>% kable()
# table(demographics_tidy$Employment.Status) %>% kable()
# table(demographics_tidy$interpreter) %>% kable()
# table(demographics_tidy$Language) %>% kable()
# table(demographics_tidy$Marital.Status) %>% kable()
# table(demographics_tidy$mcaid) %>% kable()
# table(demographics_tidy$mcare) %>% kable()
# table(demographics_tidy$Financial.Class) %>% kable()
```

Sum is 3728. 2:1 white:black. Most common employment is retired. Most married. 2:1 nonmedicaid vs yes. Most common managed care and Medicare managed care.

```{r}
  demographics_tidy %>% select(-pat_id) -> tabulate_me
  CreateTableOne(data=tabulate_me) -> t1
  kableone(t1)
```

```{r}
ggplot(demographics_tidy, aes(Age)) +   geom_density()
```

# Clinical Notes

```{r}
notes %>%
  group_by(PAT_ID) %>%
  summarise(note_count = n()) -> counted_notes

dim(counted_notes)
```

There are 100 patients for whom we have notes.

```{r message=FALSE, warning=FALSE}
ggplot(counted_notes, aes(note_count)) + geom_histogram() + scale_x_log10()
```

About 35 have only one note.

```{r message=FALSE, warning=FALSE}
counted_notes %>%
  filter(note_count > 1) -> multi_notes
ggplot(multi_notes, aes(note_count)) + geom_histogram() + scale_x_log10()

```

Many people have dozens of notes. Plenty have hundreds. A few have thousands(!)

Review this: <https://pubmed.ncbi.nlm.nih.gov/35044842/> . Sun M, Oliwa T, Peek ME, Tung EL. Negative Patient Descriptors: Documenting Racial Bias In The Electronic Health Record. *Health Aff (Millwood).* 2022;41(2):203-211. <doi:10.1377/hlthaff.2021.01423>

## Actual text processing

> Fifteen descriptors were selected for inclusion in the analysis: (non-)adherent, aggressive, agitated, angry, challenging, combative, (non-)compliant, confront, (non-)cooperative, defensive, exaggerate, hysterical, (un-)pleasant, refuse, and resist. We adjusted the descriptors to permit identification of alternative grammatical forms (for example, "adher" for "adherent," "adhere," or "adhered)

> From all sentences in the data set, we selected a random sample of sentences containing one or more of the fifteen selected patient descriptors for manual review .... We categorized the use of each descriptor in one of three possible ways: negative, positive, or out of context.

> A total of 6,818 sentences were classified.

```{r text processing}
notes %>%
  mutate(negativity = count_descriptors(NOTE_TEXT)) %>%
  mutate(abbr = substr(NOTE_TEXT, 1, 100)) %>%
  select(PAT_ID, NOTE_ID, LINE, NOTE_TEXT, abbr, negativity) -> done_processing
```

```{r sum note lines}
done_processing %>%
  arrange(NOTE_ID, LINE) %>%
  group_by(NOTE_ID) %>%
  summarise(negativity = sum(negativity),
            PAT_ID = first(PAT_ID),
            NOTE_ID = first(NOTE_ID),
            abbr = first(abbr)
            ) -> summed
```

## Distribution of neg. descriptors per patient

```{r message=FALSE, warning=FALSE}
qplot(summed$negativity) + scale_y_log10()
```

10k with 0, 1k with 1, 100 with 2, 10 with 3.

## Example data

```{r analytic dataset, echo=FALSE}
left_join(summed, demographics_tidy, by = c('PAT_ID' = 'pat_id')) %>%
  select(-abbr) -> joined

write.csv(joined, here('analytic_dataset.csv'))

joined %>%
  head() %>%
  write.csv(here('analytic_dataset_sample.csv'))

joined %>%
  select(-PAT_ID, -NOTE_ID, -mcaid, -mcare) %>%
  rename(ethnic = Ethnic.Group, employ = Employment.Status, marital = Marital.Status,
         finance = Financial.Class, interp = interpreter, lang = Language) %>%
  slice_sample(n=6) %>%
  kable()

```
**Table. Example analytic data set.** I printed the outcome variable
`negativity`, but only a selection of covariates, for simplicity. All covariates
are retained in the output CSV files.


# RESULTS: Negative descriptors vs. demographic factors

In these tables, an upward trend in ratio means positive correlation of underprivileged group status and negative descriptors. In other words, ratios are $r = u / p$, where $u$ is the count from a group hypothesized to be underprivileged, and $p$ is the group hypothesized to be privileged.

```{r}
table(joined$Sex, joined$negativity) -> x
(x[1,] / x[2,]) -> f.m.ratio
rbind(x, f.m.ratio) %>% kable()
```

More women when negativity = 1.

```{r}
table(joined$Ethnic.Group, joined$negativity)  -> x
round((x[1,] / x[2,]), 3) -> latino.non.ratio
rbind(x, latino.non.ratio) %>% kable()
```

More latino when negativity = 1 or 2.

```{r}
table(joined$Race, joined$negativity)  -> x


(x[2,] / x[5,]) -> b.w.ratio  # warning, ad-hoc row numbers
rbind(x, b.w.ratio) %>% kable()
```

Fewer AA when negativity = 1, more when = 2 or 3.

# Possible to-do items

-  Variable for "any neg descriptor, Y/N."
-  Get complete note data from IT.
-  Consider showing which descriptor (arrange like doc:term matrix).
-  Show length distribution of notes.
-  Dunning log-likelihood.
-  Do stats like `prop.trend.test` / Cochran-Armitage test for trend.
