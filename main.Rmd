---
title: "BCM Datathon Team 17 Cleaning"
author: "Andrew Zimolzak, MD, MMSc"
date: 'April, 2022'
output:
  pdf_document: default
  html_document: default
---

# Setup
```{r libraries, message=FALSE, warning=FALSE}
library(ggplot2)
library(here)
library(dplyr)
library(lubridate)
library(data.table)
library(knitr)

source(file=here("functions.R"))
```

Import data:

```{r import}

demog = filename2df('Patient Demographics 17 20220326.txt')  # 0.6 MB
# comor = filename2df('Patient Comorbidities 17 20220327.txt')  # 2.7 MB
edadm = filename2df('Patient ED Admissions 17 20220326.txt')  # 2.9 MB
# edpro = filename2df('Patient ED DX Problem List 17 20220327.txt')  # 19 MB
# medad = filename2df('Patient Meds Admin Times 17 20220327.txt')  # 93 MB
# order = filename2df('Patient Orders 17 20220327.txt')  # 86 MB
```

Tidy up the data:

```{r tidy}
edadm %>%
  mutate(
    ed_adm = ymd_hms(EMERGENCY_ADMISSION_DTTM),
	  ed_dis = ymd_hms(ED_DEPARTURE_DTTM),
	  inp_adm = ymd_hms(HOSP_ADMSN_TIME),
	  inp_dis = ymd_hms(HOSP_DISCH_TIME),
  ) %>%
  rename(cc10 = First.Chief.Compliant.ICD10, cc9 = First.Chief.Compliant.ICD9) %>%
  select(
	  PAT_ID, ED.Disposition, Patient.Class, cc10, cc9,
	  ed_adm, ed_dis, inp_adm, inp_dis
  ) %>%
  mutate(
	  adm_adm = (inp_adm - ed_adm) / ddays(),
	  dis_dis = (inp_dis - ed_dis) / ddays(),
	  ed_dur = (ed_dis - ed_adm) / ddays(),
	  inp_dur = (inp_dis - inp_adm) / ddays(),
	  er_vs_inp = inp_dur - ed_dur
  ) -> ed_encounter_tidy
```

# Descriptive tables

## Patient Class

```{r}
table(ed_encounter_tidy$Patient.Class) %>% kable()
```

## ED Disposition

```{r}
table(ed_encounter_tidy$ED.Disposition) %>% kable()
```

## Crosstabulation (disposition X class)

```{r}
table(ed_encounter_tidy$ED.Disposition, ed_encounter_tidy$Patient.Class) %>% kable()

```

Observations:

- disposition=Discharge and class=Emergency: common but not perfectly?
- d=Admit c=Inpatient: common
- d=Observation c=Observation: somewhat common
- d=Observation c=Inpatient: even more common (surprisingly)
- d=Admit class=Observation: common
- c=Outpatient: uncommon in general
- disposition=Admit class=Emergency: rare

The main dispositions that seem to matter:

- Discharge
- Admit
- Observation
- Transfer

We could make a more limited table of 4 dispo X 3 class. This is all possibly because we requested ER discharge to home and not admit?

# Sample data tables for inspection

Write a big one to disk:

```{r}
ed_encounter_tidy %>%
  select(-PAT_ID, -cc10, -cc9) -> sample_me

sample_me %>%
  slice_sample(n = 100) %>%
  arrange(ED.Disposition, Patient.Class) %>%
  fwrite(here("sample.csv"))
```

Write a short one to output document:

```{r}
sample_me %>%
  slice_sample(n=20) %>%
  arrange(Patient.Class, ED.Disposition) %>%
  transmute(
    class = tolower(substr(Patient.Class, 1, 3)),
    dispo = tolower(substr(ED.Disposition, 1, 3)),
    # er1 = ed_adm,
    # er2 = ed_dis,
    # in1 = inp_adm,
    # in2 = inp_dis,
    er1_to_inp1 = round(adm_adm, 2),
    er2_to_inp2 = round(dis_dis, 2),
    los_er = round(ed_dur, 2),
    los_inp = round(inp_dur, 2),
    diff_los = round(er_vs_inp, 2)
  ) %>%
  kable()
```

All numeric values are in **hours.**

Looks like if dispo = discharge, then ER departure time = Hospital discharge time.

# Distribution of rows per patient ID

```{r, message=FALSE}
ed_encounter_tidy %>%
  count(PAT_ID) -> pat_id_counts

qplot(x=n, data=pat_id_counts) +
  scale_x_log10()
```

# Who are the patients with multiple rows?

```{r}
left_join(ed_encounter_tidy, pat_id_counts, by='PAT_ID') %>%
  filter(Patient.Class != 'Outpatient') %>%
  filter(
    ED.Disposition == 'Admit' |
      ED.Disposition == 'Discharge' |
      ED.Disposition == 'Observation' |
      ED.Disposition == 'Transfer to Another Facility'
  ) %>%
  mutate(
    multiple = case_when(
      n > 1 ~ 'mult',
      TRUE ~ 'single'
    )
  ) -> ed_enc_w_counts
```

## Univariate tables

```{r}
table(ed_enc_w_counts$multiple, ed_enc_w_counts$Patient.Class) %>% kable()
```

```{r}
table(ed_enc_w_counts$multiple, ed_enc_w_counts$ED.Disposition) %>% kable()
```

```{r}
ed_enc_w_counts %>% filter(multiple == 'mult') -> m
ed_enc_w_counts %>% filter(multiple == 'single') -> s
```

## Crosstab limited to singles
```{r}
table(s$Patient.Class, s$ED.Disposition) %>% kable()
```

## Crosstab limited to multiples
```{r}
table(m$Patient.Class, m$ED.Disposition) %>% kable()
```

## Inspect multiples

```{r}
m %>% 
  select(PAT_ID, Patient.Class, ED.Disposition,
         ed_adm, ed_dis, inp_adm, inp_dis, n) %>%
  filter(n < 5) %>%
  arrange(PAT_ID, ed_adm) %>%
  head(25) %>%
  kable() -> inspect_multiples

# inspect_multiples
```

## Inspect singles

```{r}
s %>% 
  select(PAT_ID, Patient.Class, ED.Disposition,
         ed_adm, ed_dis, inp_adm, inp_dis, er_vs_inp, n) %>%
  arrange(PAT_ID, ed_adm) %>%
  head(25) %>%
  kable() -> inspect_singles

# inspect_singles
```

A few have an obs admit with an inpatient LOS > ER los.




# Demographics

```{r tidy demographics}
demog %>%
  select(
    pat_id, Sex, Age, Ethnic.Group, Race, Employment.Status,INTRPTR_NEEDED_YN,
    Language, Marital.Status, MEDICAID_NUM, MEDICARE_NUM, Financial.Class
  ) %>%
  rename(
    interpreter = INTRPTR_NEEDED_YN,
  ) %>%
  head() %>%
  kable()
```


